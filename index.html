<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>–†—É–ª–µ—Ç–∫–∞ —Å–∫–∏–¥–æ–∫</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{--bg:#0b0f1a;--card:#0f172a;--muted:#94a3b8;--txt:#e2e8f0;--acc:#fbbf24;--acc2:#fde68a}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#070a12 0%,#0b1020 100%);color:var(--txt);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,Arial}
    .wrap{max-width:520px;margin:0 auto;padding:16px 14px 22px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .pill{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:10px 12px;display:flex;align-items:center;gap:8px}
    .pill b{font-size:16px}
    .muted{color:var(--muted);font-size:13px;line-height:1.35}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:20px;padding:14px;margin-top:12px}
    .wheelBox{display:flex;justify-content:center;align-items:center;margin:14px 0 8px;position:relative}
    canvas{width:min(420px,92vw);height:min(420px,92vw);max-width:420px;max-height:420px}
    .pointer{position:absolute;top:-6px;width:0;height:0;border-left:14px solid transparent;border-right:14px solid transparent;border-bottom:22px solid var(--acc);filter:drop-shadow(0 8px 10px rgba(0,0,0,.45))}
    .btn{width:100%;border:0;border-radius:16px;padding:16px 16px;font-size:18px;font-weight:700;background:linear-gradient(180deg,var(--acc2),var(--acc));color:#111827;cursor:pointer}
    .btn[disabled]{opacity:.45;cursor:not-allowed}
    .danger{color:#fecaca}
    .ok{color:#bbf7d0}
    .tiny{font-size:12px;color:var(--muted)}
    .input{width:100%;box-sizing:border-box;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);color:var(--txt);padding:12px 12px;outline:none}
    .actions{display:flex;gap:10px;margin-top:10px}
    .btn2{flex:1;border-radius:14px;padding:12px 12px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:var(--text);cursor:pointer}
    .toast{margin-top:10px;font-size:14px}
    code{background:rgba(255,255,255,.06);padding:2px 6px;border-radius:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row">
      <div class="pill"><b>–ë–∞–ª–∞–Ω—Å:</b> <span id="bal">‚Ä¶</span>‚≠ê</div>
      <div class="pill"><b>–°–ø–∏–Ω:</b> <span id="cost">‚Ä¶</span>‚≠ê</div>
      <div class="pill">üéÅ <b>–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π:</b> <span id="free">‚Ä¶</span></div>
    </div>

    <div class="card">
      <div class="wheelBox">
        <div class="pointer"></div>
        <canvas id="wheel" width="900" height="900"></canvas>
      </div>
      <button id="spinBtn" class="btn" disabled>–ö—Ä—É—Ç–∏—Ç—å üé°</button>
      <div id="toast" class="toast muted"></div>

      <div class="card" style="margin-top:12px">
        <div class="muted" style="margin-bottom:8px">
          –ï—Å–ª–∏ <code>initData</code> –ø—É—Å—Ç–æ–π, Telegram –Ω–µ –¥–∞–ª —Å–µ—Å—Å–∏—é. –ù–µ –∂–º–∏ ‚Äú–æ–±–Ω–æ–≤–∏—Ç—å‚Äù –≤ –º–∏–Ω–∏-–∞–ø–ø–µ. –ó–∞–∫—Ä–æ–π –∏ –æ—Ç–∫—Ä–æ–π –∑–∞–Ω–æ–≤–æ –∫–Ω–æ–ø–∫–æ–π –≤ –±–æ—Ç–µ.
        </div>
        <div class="actions">
          <button class="btn2" id="closeBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
          <button class="btn2" id="copyBtn">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å debug</button>
        </div>
        <div style="margin-top:10px">
          <div class="tiny">API (–µ—Å–ª–∏ –Ω–µ –ø–æ–¥—Ö–≤–∞—Ç–∏–ª—Å—è –∏–∑ <code>?api=</code>):</div>
          <input id="apiInput" class="input" placeholder="https://your-api-domain" />
          <div class="actions">
            <button class="btn2" id="saveApiBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å API</button>
            <button class="btn2" id="reloadBtn">–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
          </div>
        </div>
        <div id="debug" class="tiny" style="margin-top:10px;white-space:pre-wrap"></div>
      </div>
    </div>
  </div>

<script>
(function(){
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;

  // Expand + theme
  try { tg && tg.expand(); } catch(e){}
  const qs = new URLSearchParams(location.search);
  const storedApi = localStorage.getItem('lucky_api_base') || '';
  let apiBase = (qs.get('api') || storedApi || '').trim().replace(/\/+$/,'');
  const initData = (tg && tg.initData) ? tg.initData : '';
  const initLen = initData ? initData.length : 0;

  const elBal = document.getElementById('bal');
  const elCost = document.getElementById('cost');
  const elFree = document.getElementById('free');
  const btn = document.getElementById('spinBtn');
  const toast = document.getElementById('toast');
  const debug = document.getElementById('debug');
  const apiInput = document.getElementById('apiInput');

  apiInput.value = apiBase;

  let cfg = null;
  let state = {balance:0, cost:15, free_available:false, free_left_sec:0};

  function setToast(msg, kind){
    toast.className = 'toast ' + (kind==='ok'?'ok': kind==='bad'?'danger':'muted');
    toast.textContent = msg || '';
  }

  function formatLeft(sec){
    sec = Math.max(0, Math.floor(sec||0));
    const h = String(Math.floor(sec/3600)).padStart(2,'0');
    const m = String(Math.floor((sec%3600)/60)).padStart(2,'0');
    const s = String(sec%60).padStart(2,'0');
    return `${h}:${m}:${s}`;
  }

  function canSpin(){
    const hasApi = !!apiBase;
    const hasInit = initLen>0;
    const hasFree = !!state.free_available;
    const hasStars = (state.balance||0) >= (state.cost||0);
    return hasApi && hasInit && (hasFree || hasStars);
  }

  function updateHeader(){
    elBal.textContent = String(state.balance ?? 0);
    elCost.textContent = String(state.cost ?? 15);

    if (state.free_available){
      elFree.textContent = '–¥–æ—Å—Ç—É–ø–µ–Ω ‚úÖ';
    } else {
      elFree.textContent = '—á–µ—Ä–µ–∑ ' + formatLeft(state.free_left_sec || 0);
    }
    btn.disabled = !canSpin();

    const user = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user : null;
    debug.textContent =
      `apiBase: ${apiBase || '(–ø—É—Å—Ç–æ)'}\n`+
      `initData length: ${initLen}\n`+
      `platform: ${(tg && tg.platform) || 'n/a'}\n`+
      `version: ${(tg && tg.version) || 'n/a'}\n`+
      `user_id: ${user ? user.id : 'n/a'}\n`+
      `balance: ${state.balance}\n`+
      `free_available: ${state.free_available}\n`+
      `free_left_sec: ${state.free_left_sec}\n`;
  }

  async function apiFetch(path, opts){
    if(!apiBase) throw new Error('apiBase –ø—É—Å—Ç–æ–π');
    const url = apiBase + path;
    const headers = Object.assign({'Content-Type':'application/json'}, (opts && opts.headers)||{});
    const res = await fetch(url, Object.assign({}, opts||{}, {headers, cache:'no-store'}));
    const txt = await res.text();
    let data = null;
    try{ data = JSON.parse(txt); } catch(e){ data = {raw:txt}; }
    if(!res.ok) {
      const err = (data && (data.error||data.message)) ? (data.error||data.message) : ('HTTP '+res.status);
      throw new Error(err);
    }
    return data;
  }

  // Canvas wheel
  const canvas = document.getElementById('wheel');
  const ctx = canvas.getContext('2d');
  let segments = [
    {label:'5%', color:'#1f2937'},
    {label:'10%', color:'#3b82f6'},
    {label:'15%', color:'#10b981'},
    {label:'25%', color:'#8b5cf6'},
    {label:'50%', color:'#f59e0b'},
  ];
  let angle = 0;
  let spinning = false;

  function drawWheel(){
    const W=canvas.width, H=canvas.height;
    const cx=W/2, cy=H/2;
    const r=W*0.42;
    ctx.clearRect(0,0,W,H);

    // outer ring
    ctx.beginPath();
    ctx.arc(cx,cy,r+32,0,Math.PI*2);
    ctx.fillStyle='rgba(255,255,255,.03)';
    ctx.fill();
    ctx.lineWidth=10;
    ctx.strokeStyle='rgba(255,255,255,.08)';
    ctx.stroke();

    const n = segments.length;
    const slice = (Math.PI*2)/n;

    for(let i=0;i<n;i++){
      const a0 = angle + i*slice;
      const a1 = a0 + slice;

      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.arc(cx,cy,r,a0,a1,false);
      ctx.closePath();
      ctx.fillStyle = segments[i].color;
      ctx.fill();

      // separator
      ctx.strokeStyle='rgba(255,255,255,.10)';
      ctx.lineWidth=4;
      ctx.stroke();

      // label
      ctx.save();
      ctx.translate(cx,cy);
      ctx.rotate(a0 + slice/2);
      ctx.textAlign='right';
      ctx.fillStyle='rgba(255,255,255,.92)';
      ctx.font='bold 54px -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial';
      ctx.shadowColor='rgba(0,0,0,.45)';
      ctx.shadowBlur=8;
      ctx.fillText(segments[i].label, r-18, 16);
      ctx.restore();
    }

    // center
    ctx.beginPath();
    ctx.arc(cx,cy,84,0,Math.PI*2);
    ctx.fillStyle='rgba(255,255,255,.10)';
    ctx.fill();
    ctx.lineWidth=6;
    ctx.strokeStyle='rgba(255,255,255,.14)';
    ctx.stroke();
  }
  drawWheel();

  function segmentIndexFromAngle(finalAngle){
    // Pointer at top (12 o'clock). Our angle rotates wheel, pointer fixed.
    const n=segments.length;
    const slice=(Math.PI*2)/n;
    const norm = ((-finalAngle % (Math.PI*2)) + Math.PI*2) % (Math.PI*2);
    // pointer hits angle 0. Determine which slice contains it.
    return Math.floor(norm / slice) % n;
  }

  function animateToIndex(targetIdx){
    const n=segments.length;
    const slice=(Math.PI*2)/n;
    // We want target slice center to land at pointer (angle 0).
    const targetCenter = targetIdx*slice + slice/2;
    // Need angle such that -angle == targetCenter  (mod 2pi) => angle == -targetCenter
    const desired = -targetCenter;

    const spins = 6; // full rotations
    const start = angle;
    // choose end angle as desired - spins*2pi to keep direction consistent
    let end = desired - spins*(Math.PI*2);

    // If end is too close, add more spins
    if (Math.abs(end-start) < Math.PI*6) end -= 2*(Math.PI*2);

    const dur = 2600;
    const t0 = performance.now();
    spinning=true;

    function easeOutCubic(t){ return 1-Math.pow(1-t,3); }

    function tick(t){
      const p = Math.min(1,(t-t0)/dur);
      const e = easeOutCubic(p);
      angle = start + (end-start)*e;
      drawWheel();
      if(p<1) requestAnimationFrame(tick);
      else { spinning=false; }
    }
    requestAnimationFrame(tick);
  }

  async function loadAll(){
    setToast('', '');
    if(!tg){ setToast('–û—Ç–∫—Ä–æ–π –≤–Ω—É—Ç—Ä–∏ Telegram (Mini App).', 'bad'); }
    if(initLen===0){
      setToast('initData –ø—É—Å—Ç–æ–π. –ó–∞–∫—Ä–æ–π –º–∏–Ω–∏-–∞–ø–ø –∏ –æ—Ç–∫—Ä–æ–π –∑–∞–Ω–æ–≤–æ –∫–Ω–æ–ø–∫–æ–π WebApp –≤ –±–æ—Ç–µ. –ù–µ –æ–±–Ω–æ–≤–ª—è–π —Å—Ç—Ä–∞–Ω–∏—Ü—É.', 'bad');
    }
    updateHeader();

    if(!apiBase){
      setToast('–ù–µ—Ç API. –í—Å—Ç–∞–≤—å –∞–¥—Ä–µ—Å API –≤ –ø–æ–ª–µ –Ω–∏–∂–µ –∏–ª–∏ –æ—Ç–∫—Ä–æ–π –ø–æ —Å—Å—ã–ª–∫–µ —Å ?api=...', 'bad');
      return;
    }

    try{
      cfg = await apiFetch('/api/config', {method:'GET'});
      // if server returns segments, render them; else keep defaults
      if(cfg && cfg.segments && Array.isArray(cfg.segments) && cfg.segments.length>=3){
        segments = cfg.segments.map(s => ({
          label: s.label || (String(s.id||'')+'%'),
          color: s.color || '#1f2937',
          id: s.id
        }));
      }
      state.cost = cfg.cost ?? state.cost;
      drawWheel();
    }catch(e){
      setToast('–ö–æ–Ω—Ñ–∏–≥ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è: '+e.message, 'bad');
      return;
    }

    try{
      const data = await apiFetch('/api/balance?initData='+encodeURIComponent(initData), {method:'GET'});
      if(data && data.ok){
        state.balance = data.balance ?? 0;
        state.free_available = !!data.free_available;
        state.free_left_sec = data.free_left_sec ?? 0;
      }
      updateHeader();
      setToast('–ì–æ—Ç–æ–≤–æ.', 'ok');
    }catch(e){
      setToast('–ë–∞–ª–∞–Ω—Å –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è: '+e.message, 'bad');
      updateHeader();
    }
  }

  async function doSpin(){
    if(spinning) return;
    setToast('', '');
    btn.disabled = true;

    try{
      const resp = await apiFetch('/api/spin', {
        method:'POST',
        body: JSON.stringify({initData})
      });

      // expected: {ok:true, result:{id,label,discount,code}, balance, free_available, free_left_sec}
      if(resp && resp.ok){
        const rid = resp.result && (resp.result.id ?? resp.result.discount);
        // map to segment index by label/id
        let idx = 0;
        if(rid!==undefined && rid!==null){
          const byId = segments.findIndex(s => String(s.id)===String(rid) || String(s.label).replace('%','')===String(rid));
          idx = byId>=0 ? byId : 0;
        }
        animateToIndex(idx);

        state.balance = resp.balance ?? state.balance;
        state.free_available = !!resp.free_available;
        state.free_left_sec = resp.free_left_sec ?? 0;
        updateHeader();

        const disc = resp.result && (resp.result.discount ?? resp.result.id);
        const code = resp.result && resp.result.code;
        if(code){
          setToast(`–í—ã–∏–≥—Ä—ã—à: ${disc}% üéâ –ö–æ–¥: ${code}`, 'ok');
          try{ tg && tg.HapticFeedback && tg.HapticFeedback.notificationOccurred('success'); }catch(e){}
        } else {
          setToast(`–†–µ–∑—É–ª—å—Ç–∞—Ç: ${disc}%`, 'ok');
        }
      } else {
        setToast('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞', 'bad');
      }
    } catch(e){
      setToast('–°–ø–∏–Ω –Ω–µ –ø—Ä–æ—à—ë–ª: '+e.message, 'bad');
    } finally {
      updateHeader();
    }
  }

  // Tick timer for free spin
  setInterval(() => {
    if(!state.free_available && state.free_left_sec>0){
      state.free_left_sec -= 1;
      if(state.free_left_sec<=0) state.free_available = true;
      updateHeader();
    }
  }, 1000);

  document.getElementById('saveApiBtn').onclick = () => {
    const v = apiInput.value.trim().replace(/\/+$/,'');
    apiBase = v;
    localStorage.setItem('lucky_api_base', apiBase);
    setToast('API —Å–æ—Ö—Ä–∞–Ω—ë–Ω.', 'ok');
    updateHeader();
  };
  document.getElementById('reloadBtn').onclick = () => loadAll();
  document.getElementById('closeBtn').onclick = () => { try{ tg && tg.close(); }catch(e){} };
  document.getElementById('copyBtn').onclick = async () => {
    const txt = debug.textContent + '\n' + 'url: '+location.href;
    try{ await navigator.clipboard.writeText(txt); setToast('Debug —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω.', 'ok'); }
    catch(e){ setToast('–ù–µ —Å–º–æ–≥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å: '+e.message, 'bad'); }
  };
  btn.onclick = doSpin;

  // Initial load
  loadAll();
})();
</script>
</body>
</html>
