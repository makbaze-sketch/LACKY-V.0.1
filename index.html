<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>–†—É–ª–µ—Ç–∫–∞</title>
  <style>
    :root{
      --bg:#0b0b12;
      --card:#141425;
      --text:#f3f4ff;
      --muted:#aab0d6;
      --accent:#ffd36a;
      --stroke:rgba(255,255,255,.08);
      --shadow:0 18px 60px rgba(0,0,0,.45);
      --radius:18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      background: radial-gradient(900px 560px at 50% 0%, #15153a 0%, var(--bg) 60%);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      -webkit-font-smoothing: antialiased;
      padding: 18px 14px 28px;
    }
    .card{
      max-width: 560px;
      margin: 0 auto;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--stroke);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 14px 14px 18px;
      position: relative;
      overflow: hidden;
    }
    .top{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 10px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      color: var(--text);
      font-weight: 800;
      letter-spacing: .2px;
    }
    .pill small{ color: var(--muted); font-weight: 700; }
    .row{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .gear{
      margin-left:auto;
      width: 40px; height: 40px;
      display:flex; align-items:center; justify-content:center;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      cursor: pointer;
      user-select:none;
    }
    .wheelWrap{
      display:flex;
      align-items:center;
      justify-content:center;
      margin: 10px 0 10px;
      position: relative;
    }
    canvas{
      width: min(92vw, 480px);
      aspect-ratio: 1 / 1;
      border-radius: 999px;
      background: rgba(0,0,0,.12);
      border: 1px solid var(--stroke);
      box-shadow: 0 22px 70px rgba(0,0,0,.35);
      transform: rotate(0deg);
      transition: transform 4.2s cubic-bezier(.12,.72,.12,1);
    }
    .pointer{
      position:absolute;
      top: -2px;
      width: 0; height: 0;
      border-left: 14px solid transparent;
      border-right: 14px solid transparent;
      border-top: 22px solid var(--accent);
      filter: drop-shadow(0 8px 18px rgba(0,0,0,.45));
    }
    .btn{
      width: 100%;
      margin-top: 8px;
      border: none;
      border-radius: 16px;
      padding: 14px 14px;
      font-weight: 900;
      font-size: 16px;
      letter-spacing: .2px;
      color: #0b0b12;
      background: linear-gradient(180deg, #ffe9a6, #ffd36a);
      box-shadow: 0 16px 40px rgba(0,0,0,.35);
    }
    .btn:disabled{
      opacity: .45;
      filter: grayscale(.35);
    }
    .msg{
      margin-top: 10px;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.35;
      min-height: 36px;
    }
    .fine{
      margin-top: 10px;
      color: rgba(170,176,214,.75);
      font-size: 12px;
      line-height: 1.35;
    }
    .apiBox{
      display:none;
      gap:8px;
      margin-top: 10px;
    }
    .apiBox input{
      flex:1;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline: none;
      font-weight: 700;
    }
    .apiBox button{
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.08);
      color: var(--text);
      font-weight: 900;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="top">
      <div class="row">
        <div class="pill">–ë–∞–ª–∞–Ω—Å: <span id="bal">‚Ä¶</span>‚≠ê</div>
        <div class="pill">–°–ø–∏–Ω: <span id="cost">‚Ä¶</span>‚≠ê</div>
        <div class="pill">üéÅ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π: <span id="free">‚Ä¶</span></div>
      </div>
      <div class="gear" id="gear" title="–ù–∞—Å—Ç—Ä–æ–∏—Ç—å API">‚öôÔ∏è</div>
    </div>

    <div class="wheelWrap">
      <div class="pointer"></div>
      <canvas id="wheel" width="600" height="600"></canvas>
    </div>

    <button class="btn" id="spinBtn" disabled>–ö—Ä—É—Ç–∏—Ç—å üé°</button>
    <div class="apiBox" id="apiBox">
      <input id="apiInput" placeholder="https://YOUR-BOT-DOMAIN (–±–µ–∑ / –≤ –∫–æ–Ω—Ü–µ)" />
      <button id="apiSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
    <div class="msg" id="msg">–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶</div>
    <div class="fine">
      –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç—å –Ω–µ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É WebApp –≤ –±–æ—Ç–µ, Telegram –º–æ–∂–µ—Ç –Ω–µ –ø–µ—Ä–µ–¥–∞—Ç—å <b>initData</b>, –∏ —Å–ø–∏–Ω –±—É–¥–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.
    </div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
  (() => {
    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    if (tg){ try{ tg.ready(); tg.expand(); }catch(e){} }

    const elBal = document.getElementById('bal');
    const elCost = document.getElementById('cost');
    const elFree = document.getElementById('free');
    const elBtn = document.getElementById('spinBtn');
    const elMsg = document.getElementById('msg');
    const elGear = document.getElementById('gear');
    const elApiBox = document.getElementById('apiBox');
    const elApiInput = document.getElementById('apiInput');
    const elApiSave = document.getElementById('apiSave');

    const canvas = document.getElementById('wheel');
    const ctx = canvas.getContext('2d');

    const qs = new URLSearchParams(location.search);
    const storedApi = localStorage.getItem('lucky_api_base') || '';
    let API = (qs.get('api') || '').trim() || storedApi.trim();

    // initData –º–æ–∂–µ—Ç –ø–æ—è–≤–∏—Ç—å—Å—è —á—É—Ç—å –ø–æ–∑–∂–µ
    let initData = (tg && tg.initData) ? tg.initData : '';
    setTimeout(() => {
      if (!initData && tg && tg.initData) initData = tg.initData;
      updateBtn();
    }, 350);

    let segments = [];
    let balance = 0;
    let cost = 15;

    let freeAvailable = false;
    let freeLeftSec = 0;

    let locked = false;
    let rotation = 0; // degrees
    let tickTimer = null;

    function say(html){ elMsg.innerHTML = html; }
    function fmtTime(sec){
      sec = Math.max(0, Math.floor(sec));
      const h = String(Math.floor(sec/3600)).padStart(2,'0');
      const m = String(Math.floor((sec%3600)/60)).padStart(2,'0');
      const s = String(sec%60).padStart(2,'0');
      return `${h}:${m}:${s}`;
    }
    function updateFreeUI(){
      if (freeAvailable) elFree.textContent = '–¥–æ—Å—Ç—É–ø–µ–Ω ‚úÖ';
      else elFree.textContent = '—á–µ—Ä–µ–∑ ' + fmtTime(freeLeftSec);
    }
    function updateBtn(){
      const can = freeAvailable || (balance >= cost);
      elBtn.disabled = locked || !can || !API || !initData;
      if (!initData){
        // –Ω–µ —Å–ø–∞–º–∏–º, –Ω–æ –¥–∞—ë–º –ø–æ–Ω—è—Ç—å –ø–æ—á–µ–º—É –∫–Ω–æ–ø–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞
        if (API) say('–û—Ç–∫—Ä–æ–π —Ä—É–ª–µ—Ç–∫—É –∫–Ω–æ–ø–∫–æ–π –≤ –±–æ—Ç–µ (WebApp), —á—Ç–æ–±—ã Telegram –ø–µ—Ä–µ–¥–∞–ª <b>initData</b>.');
      }
    }

    function showApiInput(){
      elApiBox.style.display = 'flex';
      elApiInput.value = API || '';
    }
    function hideApiInput(){
      elApiBox.style.display = 'none';
    }
    elGear.addEventListener('click', () => {
      if (elApiBox.style.display === 'flex') hideApiInput();
      else showApiInput();
    });
    elApiSave.addEventListener('click', () => {
      const v = (elApiInput.value || '').trim().replace(/\/+$/,'');
      if (!v){
        say('–í—Å—Ç–∞–≤—å –∞–¥—Ä–µ—Å API, –Ω–∞–ø—Ä–∏–º–µ—Ä: <b>https://xxxx.ngrok-free.dev</b>');
        return;
      }
      API = v;
      localStorage.setItem('lucky_api_base', API);
      hideApiInput();
      loadAll();
    });

    function apiUrl(path){
      return API.replace(/\/+$/,'') + path;
    }
    async function apiGet(path){
      const r = await fetch(apiUrl(path), { method:'GET' });
      const j = await r.json().catch(()=> ({}));
      if (!r.ok || j.ok === false) throw new Error(j.error || ('http_'+r.status));
      return j;
    }
    async function apiPost(path, body){
      const r = await fetch(apiUrl(path), {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body || {})
      });
      const j = await r.json().catch(()=> ({}));
      if (!r.ok || j.ok === false) throw new Error(j.error || ('http_'+r.status));
      return j;
    }

    function colorFor(id, i){
      const k = String(id||'').trim();
      if (k==='50') return '#ffd36a';
      if (k==='25') return '#b9ffb1';
      if (k==='15') return '#8fd3ff';
      if (k==='10') return '#d8b6ff';
      if (k==='5')  return '#ffffff';
      // fallback alternating
      return (i%2===0) ? '#cfd3ff' : '#f0f1ff';
    }

    function resizeCanvas(){
      const size = Math.min(520, Math.max(280, Math.floor(Math.min(window.innerWidth*0.92, 480))));
      const dpr = window.devicePixelRatio || 1;
      canvas.style.width = size + 'px';
      canvas.style.height = size + 'px';
      canvas.width = Math.floor(size * dpr);
      canvas.height = Math.floor(size * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      drawWheel(size);
    }

    function drawWheel(sizePx){
      const size = sizePx;
      const cx = size/2, cy = size/2;
      const r = size/2 - 10;

      ctx.clearRect(0,0,size,size);

      // outer soft glow
      const g = ctx.createRadialGradient(cx,cy, r*0.2, cx,cy, r);
      g.addColorStop(0, 'rgba(255,255,255,0.06)');
      g.addColorStop(1, 'rgba(255,255,255,0.00)');
      ctx.fillStyle = g;
      ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill();

      const n = Math.max(1, segments.length || 5);
      const step = (Math.PI*2)/n;
      const start0 = -Math.PI/2 - step/2; // —Ü–µ–Ω—Ç—Ä 0-–≥–æ —Å–µ–∫—Ç–æ—Ä–∞ –ø—Ä—è–º–æ —Å–≤–µ—Ä—Ö—É

      // sectors
      for (let i=0;i<n;i++){
        const seg = segments[i] || {id:'', label:'?'};
        const a0 = start0 + i*step;
        const a1 = a0 + step;

        ctx.beginPath();
        ctx.moveTo(cx,cy);
        ctx.arc(cx,cy,r,a0,a1);
        ctx.closePath();

        const base = colorFor(seg.id, i);
        // slight shade alternating
        ctx.fillStyle = base + (base.startsWith('#') ? '' : '');
        ctx.fill();

        // inner cut (for depth)
        ctx.save();
        ctx.globalCompositeOperation = 'source-atop';
        const shade = ctx.createLinearGradient(cx-r,cy-r,cx+r,cy+r);
        shade.addColorStop(0,'rgba(0,0,0,.18)');
        shade.addColorStop(1,'rgba(0,0,0,.35)');
        ctx.fillStyle = shade;
        ctx.fillRect(0,0,size,size);
        ctx.restore();

        // separators
        ctx.strokeStyle = 'rgba(0,0,0,.25)';
        ctx.lineWidth = 2;
        ctx.stroke();

        // label
        const mid = a0 + step/2;
        ctx.save();
        ctx.translate(cx,cy);
        ctx.rotate(mid);
        ctx.translate(r*0.62, 0);
        ctx.rotate(Math.PI/2);

        ctx.font = '900 ' + Math.max(16, Math.floor(size*0.06)) + 'px system-ui, -apple-system, Segoe UI, Roboto, Arial';
        ctx.fillStyle = 'rgba(11,11,18,0.92)';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        const text = (seg.label || (seg.id ? (seg.id+'%') : '?')).replace(/^-/, '');
        // light plate behind text for readability
        const padX = 10, padY = 6;
        const w = ctx.measureText(text).width + padX*2;
        const h = Math.max(26, Math.floor(size*0.09));
        ctx.save();
        ctx.globalAlpha = 0.55;
        ctx.fillStyle = 'rgba(255,255,255,0.72)';
        roundRect(ctx, -w/2, -h/2, w, h, 999);
        ctx.fill();
        ctx.restore();

        ctx.fillText(text, 0, 0);
        ctx.restore();
      }

      // center hub
      ctx.beginPath();
      ctx.arc(cx,cy,r*0.14,0,Math.PI*2);
      ctx.fillStyle = 'rgba(0,0,0,.35)';
      ctx.fill();
      ctx.beginPath();
      ctx.arc(cx,cy,r*0.10,0,Math.PI*2);
      ctx.fillStyle = 'rgba(255,211,106,.85)';
      ctx.fill();

      // outer stroke
      ctx.beginPath();
      ctx.arc(cx,cy,r,0,Math.PI*2);
      ctx.strokeStyle = 'rgba(255,255,255,0.12)';
      ctx.lineWidth = 3;
      ctx.stroke();
    }

    function roundRect(ctx, x,y,w,h,r){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr,y);
      ctx.arcTo(x+w,y,x+w,y+h,rr);
      ctx.arcTo(x+w,y+h,x,y+h,rr);
      ctx.arcTo(x,y+h,x,y,rr);
      ctx.arcTo(x,y,x+w,y,rr);
      ctx.closePath();
    }

    function setRotation(deg){
      rotation = deg;
      canvas.style.transform = `rotate(${deg}deg)`;
    }

    function animateToIndex(index){
      const n = Math.max(1, segments.length || 5);
      const stepDeg = 360 / n;

      const currentNorm = ((rotation % 360) + 360) % 360;
      const desiredNorm = ((-index * stepDeg) % 360 + 360) % 360;
      const deltaCW = (desiredNorm - currentNorm + 360) % 360;

      const spins = 4 + Math.floor(Math.random()*3); // 4..6 –æ–±–æ—Ä–æ—Ç–æ–≤
      const final = rotation + spins*360 + deltaCW;

      // force reflow to restart transition reliably
      canvas.style.transition = 'none';
      canvas.getBoundingClientRect();
      canvas.style.transition = 'transform 4.2s cubic-bezier(.12,.72,.12,1)';
      setRotation(final);

      return new Promise(res => {
        const onEnd = () => res();
        canvas.addEventListener('transitionend', onEnd, { once:true });
      });
    }

    function applyBalancePayload(b){
      balance = Number(b.balance || 0);
      cost = Number(b.cost || cost || 15);

      // –≤–∞–∂–Ω—ã–π —Ñ–∏–∫—Å: –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ –ø—Ä–∏—Å–ª–∞–ª –ø–æ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, balance –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è),
      // —Ç–æ free_available –º–æ–∂–µ—Ç –±—ã—Ç—å undefined. –¢–æ–≥–¥–∞ —Å—á–∏—Ç–∞–µ–º –ø–æ free_left_sec.
      const fa = (typeof b.free_available === 'boolean') ? b.free_available : null;
      const fl = Number((b.free_left_sec != null) ? b.free_left_sec : 0);
      freeLeftSec = Math.max(0, fl);

      if (fa === null){
        freeAvailable = (freeLeftSec <= 0);
      } else {
        freeAvailable = fa || (freeLeftSec <= 0);
      }

      elBal.textContent = String(balance);
      elCost.textContent = String(cost);
      updateFreeUI();
      updateBtn();
    }

    function startCountdown(){
      if (tickTimer) return;
      tickTimer = setInterval(() => {
        if (!freeAvailable && freeLeftSec > 0){
          freeLeftSec -= 1;
          if (freeLeftSec <= 0){
            freeLeftSec = 0;
            freeAvailable = true;
          }
          updateFreeUI();
          updateBtn();
        }
      }, 1000);
    }

    async function loadAll(){
      if (!API){
        say('–ù—É–∂–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä <b>?api=</b> –∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π API –∞–¥—Ä–µ—Å.');
        showApiInput();
        updateBtn();
        return;
      }
      hideApiInput();
      try{
        say('–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶');

        const cfg = await apiGet('/api/config');
        cost = Number(cfg.cost || 15);
        segments = Array.isArray(cfg.segments) ? cfg.segments : [];
        if (!segments.length){
          segments = [
            {id:'5',label:'5%'},
            {id:'10',label:'10%'},
            {id:'15',label:'15%'},
            {id:'25',label:'25%'},
            {id:'50',label:'50%'}
          ];
        }
        resizeCanvas();

        if (!initData){
          say('–û—Ç–∫—Ä–æ–π —Ä—É–ª–µ—Ç–∫—É –∫–Ω–æ–ø–∫–æ–π –≤ –±–æ—Ç–µ (WebApp), —á—Ç–æ–±—ã Telegram –ø–µ—Ä–µ–¥–∞–ª <b>initData</b>.');
          updateBtn();
          return;
        }

        const bal = await apiGet('/api/balance?initData=' + encodeURIComponent(initData));
        applyBalancePayload(bal);
        startCountdown();
        say('–ú–æ–∂–Ω–æ –∫—Ä—É—Ç–∏—Ç—å ‚ú®');
      }catch(e){
        console.error(e);
        say('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: <b>' + (e && e.message ? e.message : 'unknown') + '</b>');
        updateBtn();
      }
    }

    elBtn.addEventListener('click', async () => {
      if (locked) return;
      locked = true;
      updateBtn();
      say('–ö—Ä—É—á—É‚Ä¶');
      try{
        const res = await apiPost('/api/spin', { initData });
        const idx = Number(res?.result?.index ?? 0);
        await animateToIndex(idx);

        applyBalancePayload(res);

        const percent = Number(res?.result?.percent || 0);
        const code = res?.result?.code || '';
        if (percent > 0){
          say(`–í—ã–ø–∞–ª–æ <b>${percent}%</b> ‚úÖ<br>–ö–æ–¥: <b>${code}</b>`);
          if (tg){
            try{
              tg.showAlert(`–¢–≤–æ—è —Å–∫–∏–¥–∫–∞ ${percent}%\n–ö–æ–¥: ${code}`);
            }catch(e){}
          }
        } else {
          say('–°–µ–∫—Ç–æ—Ä –±–µ–∑ —Å–∫–∏–¥–∫–∏ üò∂');
        }
      }catch(e){
        console.error(e);
        const msg = (e && e.message) ? e.message : 'unknown';
        if (msg === 'not_enough_stars') say('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç ‚≠ê –¥–ª—è —Å–ø–∏–Ω–∞. –ñ–¥–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∏–ª–∏ –ø–æ–ø–æ–ª–Ω–∏ –±–∞–ª–∞–Ω—Å.');
        else if (msg === 'bad_init_data') say('Telegram –Ω–µ –ø–µ—Ä–µ–¥–∞–ª initData. –û—Ç–∫—Ä–æ–π —Ä—É–ª–µ—Ç–∫—É –∫–Ω–æ–ø–∫–æ–π –≤ –±–æ—Ç–µ.');
        else say('–û—à–∏–±–∫–∞ —Å–ø–∏–Ω–∞: <b>' + msg + '</b>');
      }finally{
        locked = false;
        updateBtn();
      }
    });

    window.addEventListener('resize', () => resizeCanvas());
    resizeCanvas();
    loadAll();
  })();
  </script>
</body>
</html>

